name: Version Bump

on:
  workflow_dispatch:
    inputs:
      version_type:
        description: 'Version bump type'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major
      pre_release:
        description: 'Pre-release version (e.g., alpha, beta, rc)'
        required: false
        type: string

jobs:
  bump-version:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Configure Git
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
    - name: Get current version
      id: current_version
      run: |
        CURRENT_VERSION=$(jq -r '.version' manifest.json)
        echo "CURRENT_VERSION=$CURRENT_VERSION" >> $GITHUB_OUTPUT
        echo "Current version: $CURRENT_VERSION"
        
    - name: Calculate new version
      id: new_version
      run: |
        CURRENT_VERSION="${{ steps.current_version.outputs.CURRENT_VERSION }}"
        VERSION_TYPE="${{ github.event.inputs.version_type }}"
        PRE_RELEASE="${{ github.event.inputs.pre_release }}"
        
        # Split version into components
        IFS='.' read -ra VERSION_PARTS <<< "$CURRENT_VERSION"
        MAJOR=${VERSION_PARTS[0]}
        MINOR=${VERSION_PARTS[1]}
        PATCH=${VERSION_PARTS[2]}
        
        # Handle pre-release versions
        if [[ $PATCH =~ ^[0-9]+-(.+)$ ]]; then
          PATCH=$(echo $PATCH | cut -d'-' -f1)
        fi
        
        # Bump version based on type
        case $VERSION_TYPE in
          major)
            MAJOR=$((MAJOR + 1))
            MINOR=0
            PATCH=0
            ;;
          minor)
            MINOR=$((MINOR + 1))
            PATCH=0
            ;;
          patch)
            PATCH=$((PATCH + 1))
            ;;
        esac
        
        # Add pre-release suffix if specified
        if [ -n "$PRE_RELEASE" ]; then
          NEW_VERSION="${MAJOR}.${MINOR}.${PATCH}-${PRE_RELEASE}"
        else
          NEW_VERSION="${MAJOR}.${MINOR}.${PATCH}"
        fi
        
        echo "NEW_VERSION=$NEW_VERSION" >> $GITHUB_OUTPUT
        echo "New version: $NEW_VERSION"
        
    - name: Update manifest.json
      run: |
        NEW_VERSION="${{ steps.new_version.outputs.NEW_VERSION }}"
        jq --arg version "$NEW_VERSION" '.version = $version' manifest.json > manifest.json.tmp
        mv manifest.json.tmp manifest.json
        echo "Updated manifest.json with version $NEW_VERSION"
        
    - name: Update versions.json
      run: |
        NEW_VERSION="${{ steps.new_version.outputs.NEW_VERSION }}"
        MIN_APP_VERSION=$(jq -r '.minAppVersion' manifest.json)
        
        # Add new version to versions.json
        jq --arg version "$NEW_VERSION" --arg minVersion "$MIN_APP_VERSION" \
          '.[$version] = $minVersion' versions.json > versions.json.tmp
        mv versions.json.tmp versions.json
        echo "Updated versions.json with version $NEW_VERSION"
        
    - name: Install dependencies and build
      run: |
        npm ci
        npm run build
        
    - name: Commit version changes
      run: |
        git add manifest.json versions.json
        git commit -m "chore: bump version to ${{ steps.new_version.outputs.NEW_VERSION }}"
        
    - name: Create version tag
      run: |
        NEW_VERSION="${{ steps.new_version.outputs.NEW_VERSION }}"
        git tag -a "v$NEW_VERSION" -m "Release version $NEW_VERSION"
        
    - name: Push changes and tag
      run: |
        git push origin HEAD:${{ github.ref_name }}
        git push origin "v${{ steps.new_version.outputs.NEW_VERSION }}"
        
    - name: Create GitHub Release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: v${{ steps.new_version.outputs.NEW_VERSION }}
        release_name: Release ${{ steps.new_version.outputs.NEW_VERSION }}
        draft: false
        prerelease: ${{ github.event.inputs.pre_release != '' }}
        body: |
          ## Version ${{ steps.new_version.outputs.NEW_VERSION }}
          
          This release was automatically generated by the version bump workflow.
          
          ### Changes
          
          See commit history for detailed changes.
          
          ### Installation
          
          1. Download the `main.js`, `manifest.json`, and `styles.css` files from the release assets
          2. Copy these files to your Obsidian vault's `.obsidian/plugins/bookmark-creator/` directory
          3. Restart Obsidian and enable the plugin in Settings > Community plugins
          
    - name: Upload Release Assets
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./main.js
        asset_name: main.js
        asset_content_type: application/javascript
        
    - name: Upload Manifest Asset
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./manifest.json
        asset_name: manifest.json
        asset_content_type: application/json
