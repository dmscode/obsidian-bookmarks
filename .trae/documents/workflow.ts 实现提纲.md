# workflow.ts 实现提纲

## 1. 核心类设计

### 1.1 WorkflowManager 类
- **职责**：协调整个书签创建流程，管理步骤执行顺序和状态
- **构造函数**：接收插件实例、AI服务实例和文件管理实例
- **核心属性**：
  - 当前流程状态
  - 步骤执行上下文
  - 数据存储对象

## 2. 流程控制机制

### 2.1 初始化流程
- 解析输入类型（YAML或URL）
- 根据输入类型选择处理模式（完整/简单）
- 初始化步骤列表

### 2.2 步骤执行逻辑
- 实现 `executeStep()` 方法，处理单个步骤
- 步骤间数据传递机制
- 异步步骤执行和等待

### 2.3 状态管理
- 步骤状态更新（pending/processing/completed/failed）
- 进度回调机制
- 错误处理和重试逻辑

## 3. 具体步骤实现

### 3.1 获取网页内容（get-web-content）
- 调用 Jina AI API 获取网页内容
- 内容解析和验证
- 数据存储

### 3.2 获取网站评价（get-web-rating）
- 调用 Jina AI 搜索获取网站评价
- 评价内容处理
- 数据整合

### 3.3 生成书签信息（generate-bookmark-info）
- 调用 AI 生成书签 YAML
- YAML 解析和验证
- 书签数据结构化

### 3.4 下载网站截图（download-web-screenshot）
- 调用 Thum.io API 下载截图
- 截图保存和命名
- 文件路径管理

### 3.5 创建书签笔记（create-bookmark-note）
- 构建笔记内容
- 创建 Obsidian 笔记文件
- 处理文件命名冲突

## 4. 与其他模块集成

### 4.1 与模态框集成
- 进度更新回调
- 流程完成通知
- 错误信息传递

### 4.2 与等待队列集成
- 队列项添加和移除
- 步骤状态同步
- 事件监听机制

### 4.3 与文件管理器集成
- 文件夹创建和验证
- 截图下载和保存
- 笔记文件创建

## 5. 错误处理和日志

### 5.1 错误类型定义
- API 错误
- 文件系统错误
- 数据格式错误

### 5.2 错误处理策略
- 步骤级错误捕获
- 流程回滚机制
- 用户友好的错误提示

### 5.3 日志记录
- 流程执行日志
- 错误日志
- 调试信息

## 6. 测试和优化

### 6.1 单元测试用例
- 步骤执行测试
- 错误处理测试
- 数据传递测试

### 6.2 性能优化
- 异步执行优化
- 内存管理
- API 调用优化

## 7. 代码结构和命名规范

### 7.1 代码组织
- 类和方法划分
- 模块导入顺序
- 注释规范

### 7.2 命名规范
- 类名：PascalCase
- 方法名：camelCase
- 变量名：camelCase
- 常量名：UPPER_CASE

## 8. 扩展性考虑

### 8.1 新增步骤支持
- 步骤注册机制
- 动态步骤加载

### 8.2 第三方服务集成
- 服务接口抽象
- 多服务支持

### 8.3 配置扩展
- 流程配置选项
- 步骤参数配置

通过以上提纲实现的 workflow.ts 将能够完整协调整个书签创建流程，实现从用户输入到最终笔记创建的全流程自动化管理。